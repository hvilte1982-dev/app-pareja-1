<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">
    <title>HomeHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --success: #4caf50;
            --danger: #f44336;
            --bg-main: #f5f5f5;
            --bg-card: #ffffff;
            --text-main: #333333;
            --text-muted: #999999;
            --border: #e0e0e0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-main); color: var(--text-main); }
        #app { display: flex; flex-direction: column; height: 100vh; max-width: 500px; margin: 0 auto; background: var(--bg-main); }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .header h1 { font-size: 1.2rem; font-weight: 700; }
        .header p { font-size: 0.8rem; opacity: 0.9; }
        .header button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .sync-status { font-size: 0.7rem; opacity: 0.8; }
        #content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; height: 70px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 1000; }
        .nav-btn { flex: 1; border: none; background: none; color: var(--text-muted); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; font-size: 0.65rem; font-weight: 600; }
        .nav-btn.active { color: var(--primary); }
        .card { background: var(--bg-card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 12px; }
        .card h3 { font-size: 0.95rem; margin-bottom: 10px; }
        .item { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--primary); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-weight: bold; font-size: 0.75rem; }
        .checkbox.checked { background: var(--primary); color: white; }
        .item-text { flex: 1; }
        .item-text.done { text-decoration: line-through; opacity: 0.5; }
        .btn-del { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.85rem; padding: 4px 8px; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 20px; padding: 20px; background: white; }
        .login-screen h1 { color: var(--primary); font-size: 2rem; }
        .login-screen input { width: 100%; max-width: 280px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; }
        .login-screen button { width: 100%; max-width: 280px; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .empty { text-align: center; color: var(--text-muted); padding: 20px; font-style: italic; }
        .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .chip { padding: 6px 12px; border: 1px solid var(--border); border-radius: 20px; background: white; cursor: pointer; font-size: 0.8rem; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .stat-box { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="app" style="display:none;">
        <div class="header">
            <div>
                <h1>HomeHub</h1>
                <p id="user-name">Usuario</p>
                <p class="sync-status" id="sync-status">üîÑ Sincronizando...</p>
            </div>
            <button onclick="logout()">Salir</button>
        </div>
        
        <div id="content"></div>
        
        <nav class="nav">
            <button class="nav-btn active" onclick="setView('dashboard', this)"><i class="fas fa-home"></i><span>Inicio</span></button>
            <button class="nav-btn" onclick="setView('shopping', this)"><i class="fas fa-shopping-cart"></i><span>Compras</span></button>
            <button class="nav-btn" onclick="setView('tasks', this)"><i class="fas fa-list-check"></i><span>Tareas</span></button>
            <button class="nav-btn" onclick="setView('plants', this)"><i class="fas fa-leaf"></i><span>Plantas</span></button>
            <button class="nav-btn" onclick="setView('expenses', this)"><i class="fas fa-chart-pie"></i><span>Gastos</span></button>
        </nav>
    </div>

    <div id="login" class="login-screen">
        <h1>üè† HomeHub</h1>
        <p>Organizaci√≥n del hogar para parejas</p>
        <input id="name-input" type="text" placeholder="Nombre de tu pareja (ej: Juan&Maria)" />
        <button id="login-btn">Entrar</button>
        <p style="font-size:0.75rem; color:var(--text-muted); margin-top:20px; text-align:center;">Ambos usan el MISMO nombre para compartir datos</p>
    </div>

    <!-- ‚úÖ FIX: Cargar Supabase antes del script principal -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ‚úÖ FIX: Usar un nombre de variable diferente para evitar conflicto con window.supabase
        const SUPABASE_URL = 'https://blckzxhtpxxwhlsksrzz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsY2t6eGh0cHh4d2hsc2tzcnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjU2MTgsImV4cCI6MjA4NjM0MTYxOH0.z62ADKWvhCvHSN2mHEqk_PCDEV_Jnn5g2wGPcK-he3g';
        
        // ‚úÖ FIX: Renombrado a 'sbClient' para no chocar con el namespace 'supabase' del CDN
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentView = 'dashboard';
        let appData = { shopping: {}, tasks: {}, plants: {}, expenses: {} };
        let filterShop = 'todos'; // ‚úÖ FIX: filterShop separado para que no se pierda al recargar datos
        let syncSubscription = null;

        // ‚úÖ FIX: Storage helper con fallback a memoria si localStorage est√° bloqueado
        const storage = {
            _mem: {},
            set(key, val) {
                try { localStorage.setItem(key, val); } catch(e) { this._mem[key] = val; }
            },
            get(key) {
                try { return localStorage.getItem(key); } catch(e) { return this._mem[key] || null; }
            },
            remove(key) {
                try { localStorage.removeItem(key); } catch(e) { delete this._mem[key]; }
            }
        };

        // ‚úÖ FIX: Bot√≥n usa addEventListener en lugar de onclick inline para evitar problemas de scope
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('name-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        async function login() {
            const name = document.getElementById('name-input').value.trim();
            if (!name) {
                alert('Escribe el nombre compartido de tu pareja');
                return;
            }
            
            currentUser = name;
            storage.set('homehub-user', name);
            
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('user-name').textContent = 'üë§ ' + name;
            
            await loadFromSupabase();
            subscribeToChanges();
            render();
        }

        function logout() {
            if (syncSubscription) {
                sbClient.removeChannel(syncSubscription);
                syncSubscription = null;
            }
            currentUser = null;
            storage.remove('homehub-user');
            appData = { shopping: {}, tasks: {}, plants: {}, expenses: {} };
            filterShop = 'todos';
            document.getElementById('app').style.display = 'none';
            document.getElementById('login').style.display = 'flex';
            document.getElementById('name-input').value = '';
        }

        async function loadFromSupabase() {
            try {
                updateSyncStatus('üîÑ Cargando...');
                const { data: records, error } = await sbClient
                    .from('homehub_data')
                    .select('*')
                    .eq('user_name', currentUser)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error al cargar:', error);
                    updateSyncStatus('‚ùå Error al cargar');
                    return;
                }
                
                if (records && records.data_json) {
                    const parsed = JSON.parse(records.data_json);
                    // ‚úÖ FIX: Merge seguro para no perder filterShop ni claves nuevas
                    appData = {
                        shopping: parsed.shopping || {},
                        tasks: parsed.tasks || {},
                        plants: parsed.plants || {},
                        expenses: parsed.expenses || {}
                    };
                }
                
                updateSyncStatus('‚úÖ Sincronizado');
            } catch (e) {
                console.error('Error:', e);
                updateSyncStatus('‚ùå Error de conexi√≥n');
            }
        }

        async function saveToSupabase() {
            if (!currentUser) return;
            
            try {
                updateSyncStatus('üîÑ Guardando...');
                
                const { error } = await sbClient
                    .from('homehub_data')
                    .upsert({
                        user_name: currentUser,
                        data_json: JSON.stringify(appData),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_name'
                    });
                
                if (error) {
                    console.error('Error al guardar:', error);
                    updateSyncStatus('‚ùå Error al guardar');
                } else {
                    updateSyncStatus('‚úÖ Guardado');
                }
            } catch (e) {
                console.error('Error:', e);
                updateSyncStatus('‚ùå Error');
            }
        }

        function subscribeToChanges() {
            // ‚úÖ FIX: Canal √∫nico por usuario para sincronizaci√≥n correcta entre dos tel√©fonos
            if (syncSubscription) {
                sbClient.removeChannel(syncSubscription);
            }
            
            const channelName = 'homehub-' + currentUser.replace(/[^a-zA-Z0-9]/g, '-');
            
            syncSubscription = sbClient
                .channel(channelName)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'homehub_data',
                    filter: `user_name=eq.${currentUser}`
                }, (payload) => {
                    if (payload.new && payload.new.data_json) {
                        const parsed = JSON.parse(payload.new.data_json);
                        appData = {
                            shopping: parsed.shopping || {},
                            tasks: parsed.tasks || {},
                            plants: parsed.plants || {},
                            expenses: parsed.expenses || {}
                        };
                        render();
                        updateSyncStatus('‚úÖ Actualizado en tiempo real');
                        setTimeout(() => updateSyncStatus('‚úÖ Sincronizado'), 2000);
                    }
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        updateSyncStatus('‚úÖ Sincronizado');
                    } else if (status === 'CHANNEL_ERROR') {
                        updateSyncStatus('‚ö†Ô∏è Sin conexi√≥n en vivo');
                    }
                });
        }

        function updateSyncStatus(status) {
            const statusEl = document.getElementById('sync-status');
            if (statusEl) statusEl.textContent = status;
        }

        // ‚úÖ FIX: setView recibe el bot√≥n como par√°metro para no depender de 'event'
        function setView(v, btn) {
            currentView = v;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            render();
        }

        async function addShopping() {
            const name = prompt('Nombre del producto:');
            if (!name) return;
            const cat = prompt('Categor√≠a (Almac√©n/Limpieza/Heladera/Otros):') || 'Otros';
            appData.shopping[Date.now()] = {name, cat, bought: false};
            await saveToSupabase();
            render();
        }

        async function toggleShopping(id) {
            if (appData.shopping[id]) {
                appData.shopping[id].bought = !appData.shopping[id].bought;
                await saveToSupabase();
                render();
            }
        }

        async function delShopping(id) {
            delete appData.shopping[id];
            await saveToSupabase();
            render();
        }

        async function addTask() {
            const title = prompt('T√≠tulo de la tarea:');
            if (!title) return;
            const date = prompt('Fecha (YYYY-MM-DD):') || '';
            const time = prompt('Hora (HH:MM):') || '';
            appData.tasks[Date.now()] = {title, date, time, status: 'pendiente'};
            await saveToSupabase();
            render();
        }

        async function toggleTask(id) {
            if (appData.tasks[id]) {
                appData.tasks[id].status = appData.tasks[id].status === 'pendiente' ? 'finalizado' : 'pendiente';
                await saveToSupabase();
                render();
            }
        }

        async function delTask(id) {
            delete appData.tasks[id];
            await saveToSupabase();
            render();
        }

        async function addPlant() {
            const name = prompt('Nombre de la planta:');
            if (!name) return;
            const freq = prompt('Riego cada (d√≠as):') || '3';
            appData.plants[Date.now()] = {name, frequency: parseInt(freq), lastWatered: new Date().toISOString()};
            await saveToSupabase();
            render();
        }

        async function waterPlant(id) {
            if (appData.plants[id]) {
                appData.plants[id].lastWatered = new Date().toISOString();
                await saveToSupabase();
                render();
            }
        }

        async function delPlant(id) {
            delete appData.plants[id];
            await saveToSupabase();
            render();
        }

        async function addExpense() {
            const desc = prompt('Descripci√≥n:');
            if (!desc) return;
            const amount = prompt('Monto:');
            if (!amount || isNaN(amount)) return;
            const cat = prompt('Categor√≠a (Comida/Compras/Casa/Otro):') || 'Otro';
            appData.expenses[Date.now()] = {desc, amount: parseFloat(amount), cat, date: new Date().toISOString()};
            await saveToSupabase();
            render();
        }

        async function delExpense(id) {
            delete appData.expenses[id];
            await saveToSupabase();
            render();
        }

        function render() {
            const c = document.getElementById('content');
            c.innerHTML = '';
            if (currentView === 'dashboard') renderDash(c);
            else if (currentView === 'shopping') renderShop(c);
            else if (currentView === 'tasks') renderTasks(c);
            else if (currentView === 'plants') renderPlants(c);
            else if (currentView === 'expenses') renderExp(c);
        }

        function renderDash(c) {
            const sc = Object.values(appData.shopping).filter(x => !x.bought).length;
            const tc = Object.values(appData.tasks).filter(x => x.status === 'pendiente').length;
            const total = Object.values(appData.expenses).reduce((s, e) => s + e.amount, 0);
            c.innerHTML = `
                <div class="stat-box">
                    <div class="stat-row"><span>üõí Por comprar:</span> <strong>${sc}</strong></div>
                    <div class="stat-row"><span>üìã Tareas pendientes:</span> <strong>${tc}</strong></div>
                    <div class="stat-row"><span>üí∞ Total gastos:</span> <strong>$${total.toFixed(2)}</strong></div>
                </div>
                <div class="card"><h3>üìã Pr√≥ximas Tareas</h3>${Object.entries(appData.tasks).filter(([_,t]) => t.status === 'pendiente').slice(0,3).map(([id,t]) => `<div class="item"><div class="checkbox" onclick="toggleTask('${id}')"></div><div class="item-text">${t.title}</div></div>`).join('') || '<p class="empty">Sin tareas pendientes</p>'}</div>
                <div class="card"><h3>üõí Lista de Compras</h3>${Object.entries(appData.shopping).filter(([_,s]) => !s.bought).slice(0,3).map(([id,s]) => `<div class="item"><div class="checkbox" onclick="toggleShopping('${id}')"></div><div class="item-text">${s.name}</div></div>`).join('') || '<p class="empty">Lista vac√≠a</p>'}</div>
            `;
        }

        function renderShop(c) {
            const items = Object.entries(appData.shopping);
            const cats = [...new Set(items.map(([_,i]) => i.cat))];
            c.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <h2>üõí Compras</h2>
                    <button class="btn-add" onclick="addShopping()">+ Agregar</button>
                </div>
                <div class="chips">
                    <button class="chip ${filterShop === 'todos' ? 'active' : ''}" onclick="filterShop='todos'; render()">Todos</button>
                    ${cats.map(cat => `<button class="chip ${filterShop === cat ? 'active' : ''}" onclick="filterShop='${cat}'; render()">${cat}</button>`).join('')}
                </div>
                ${items.filter(([_,i]) => filterShop === 'todos' || i.cat === filterShop).map(([id,item]) => `
                    <div class="item">
                        <div class="checkbox ${item.bought ? 'checked' : ''}" onclick="toggleShopping('${id}')">${item.bought ? '‚úì' : ''}</div>
                        <div class="item-text ${item.bought ? 'done' : ''}">${item.name}<br><small>${item.cat}</small></div>
                        <button class="btn-del" onclick="delShopping('${id}')">‚úï</button>
                    </div>`).join('') || '<p class="empty">Sin productos</p>'}
            `;
        }

        function renderTasks(c) {
            const tasks = Object.entries(appData.tasks);
            c.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <h2>üìã Tareas</h2>
                    <button class="btn-add" onclick="addTask()">+ Agregar</button>
                </div>
                ${tasks.map(([id,task]) => `
                    <div class="card" style="border-left:5px solid ${task.status === 'finalizado' ? 'var(--success)' : 'var(--primary)'}">
                        <h3>${task.title}</h3>
                        <small>${task.date} ${task.time || ''}</small>
                        <div style="display:flex; gap:6px; margin-top:8px;">
                            <button class="btn-add" style="padding:6px 8px;" onclick="toggleTask('${id}')">${task.status === 'finalizado' ? '‚Ü© Reabrir' : '‚úì Finalizar'}</button>
                            <button class="btn-del" onclick="delTask('${id}')">‚úï Eliminar</button>
                        </div>
                    </div>`).join('') || '<p class="empty">Sin tareas</p>'}
            `;
        }

        function renderPlants(c) {
            const plants = Object.entries(appData.plants);
            c.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <h2>üå± Plantas</h2>
                    <button class="btn-add" onclick="addPlant()">+ Agregar</button>
                </div>
                ${plants.map(([id,plant]) => {
                    const last = new Date(plant.lastWatered);
                    const daysSince = Math.floor((Date.now() - last) / 86400000);
                    const needsWater = daysSince >= plant.frequency;
                    return `
                    <div class="item" style="border-left:4px solid ${needsWater ? 'var(--danger)' : 'var(--success)'}">
                        <div style="flex:1;">
                            <strong>${plant.name}</strong> ${needsWater ? 'üíß‚ö†Ô∏è Necesita riego' : '‚úÖ'}
                            <br><small>Cada ${plant.frequency} d√≠as ¬∑ √öltimo riego: hace ${daysSince} d√≠as</small>
                        </div>
                        <button class="btn-add" style="padding:6px 8px;" onclick="waterPlant('${id}')">üíß</button>
                        <button class="btn-del" onclick="delPlant('${id}')">‚úï</button>
                    </div>`;
                }).join('') || '<p class="empty">Sin plantas</p>'}
            `;
        }

        function renderExp(c) {
            const exps = Object.entries(appData.expenses);
            const total = exps.reduce((s,[_,e]) => s + e.amount, 0);
            const byCat = {};
            exps.forEach(([_,e]) => { byCat[e.cat] = (byCat[e.cat] || 0) + e.amount; });
            c.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <h2>üí∞ Gastos</h2>
                    <button class="btn-add" onclick="addExpense()">+ Agregar</button>
                </div>
                <div class="stat-box">
                    <div class="stat-row"><span>Total del mes</span> <strong>$${total.toFixed(2)}</strong></div>
                </div>
                <h4 style="margin:15px 0 10px;">Por Categor√≠a</h4>
                ${Object.entries(byCat).map(([cat,amt]) => `
                    <div style="display:flex; justify-content:space-between; padding:10px; background:white; border-radius:6px; margin-bottom:8px; border:1px solid var(--border);">
                        <span>${cat}</span> <strong>$${amt.toFixed(2)}</strong>
                    </div>`).join('')}
                <h4 style="margin:15px 0 10px;">Transacciones</h4>
                ${exps.sort((a,b) => b[0]-a[0]).map(([id,exp]) => `
                    <div class="item">
                        <div style="flex:1;"><strong>${exp.desc}</strong><br><small>${exp.cat} ¬∑ ${new Date(exp.date).toLocaleDateString()}</small></div>
                        <strong>$${exp.amount.toFixed(2)}</strong>
                        <button class="btn-del" onclick="delExpense('${id}')">‚úï</button>
                    </div>`).join('') || '<p class="empty">Sin gastos registrados</p>'}
            `;
        }

        // ‚úÖ FIX: Auto-login al cargar la p√°gina
        window.onload = async function() {
            const saved = storage.get('homehub-user');
            if (saved) {
                currentUser = saved;
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('user-name').textContent = 'üë§ ' + saved;
                
                await loadFromSupabase();
                subscribeToChanges();
                render();
            }
        };
    </script>
</body>
  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = "https://TU_SUPABASE_URL.supabase.co"; 
    const SUPABASE_KEY = "TU_API_KEY"; 

    async function cargarDatos() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/tabla?user_name=eq.pareja`, {
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          throw new Error("Error en la respuesta: " + response.status);
        }

        const data = await response.json();
        console.log("Datos recibidos:", data);

        const contenedor = document.getElementById("resultado");
        if (contenedor) {
          contenedor.innerHTML = JSON.stringify(data, null, 2);
        }

      } catch (error) {
        console.error("Hubo un problema:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", cargarDatos);
  </script>
</body>
</html>
    
</html>
