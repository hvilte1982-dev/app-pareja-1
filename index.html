<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    <title>HomeHub | Versi√≥n Maestra</title>
    <!-- Supabase SDK v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: hsl(250, 60%, 60%);
            --primary-light: hsl(250, 60%, 85%);
            --primary-dark: hsl(250, 60%, 40%);
            --secondary: hsl(180, 50%, 45%);
            --accent: hsl(30, 90%, 60%);
            --success: hsl(145, 50%, 50%);
            --danger: hsl(0, 70%, 60%);
            --warning: hsl(45, 90%, 60%);
            --bg-main: hsl(220, 20%, 97%);
            --bg-card: hsl(0, 0%, 100%);
            --text-main: hsl(220, 15%, 15%);
            --text-muted: hsl(220, 10%, 45%);
            --border: hsl(220, 15%, 90%);
            --glass-bg: hsla(0, 0%, 100%, 0.7);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --nav-height: 70px;
            --header-height: 85px;
            --radius-md: 18px;
            --radius-lg: 30px;
        }

        .dark-mode {
            --bg-main: hsl(220, 25%, 8%);
            --bg-card: hsl(220, 25%, 15%);
            --text-main: hsl(220, 15%, 95%);
            --text-muted: hsl(220, 10%, 65%);
            --border: hsl(220, 20%, 20%);
            --glass-bg: hsla(220, 25%, 12%, 0.85);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            background: var(--bg-main);
            transition: background 0.3s;
        }

        /* header */
        .app-header {
            height: var(--header-height);
            padding: env(safe-area-inset-top) 15px 0 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 3px solid var(--bg-card);
            background-size: cover;
            background-color: var(--primary-light);
            margin-left: -10px;
        }

        .avatar:first-child {
            margin-left: 0;
            z-index: 2;
        }

        .header-text h1 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .header-text p {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .icon-btn {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background: var(--bg-card);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        /* bottom nav - 6 items layout */
        .bottom-nav {
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            border-top: 1px solid var(--border);
            z-index: 1000;
            padding: 0 5px env(safe-area-inset-bottom) 5px;
        }

        .nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.55rem;
            font-weight: 700;
        }

        .nav-item i {
            font-size: 1.1rem;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* content */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px;
        }

        /* cards */
        .dash-card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid var(--border);
        }

        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .full-width {
            grid-column: span 2;
        }

        .card-icon {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .list-item {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.75rem;
        }

        .custom-checkbox.checked {
            background: var(--primary);
            color: white;
        }

        /* Chips categories */
        .chips-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 2px 0 10px 0;
            margin-bottom: 10px;
            scrollbar-width: none;
        }

        .chip {
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 0.65rem;
            font-weight: 800;
            white-space: nowrap;
            color: var(--text-muted);
        }

        .chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Mini labels */
        .label-cat {
            font-size: 0.55rem;
            text-transform: uppercase;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-main);
            color: var(--text-muted);
        }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .cal-day {
            background: var(--bg-card);
            padding: 6px 2px;
            min-height: 50px;
            text-align: center;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .cal-day.today {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 800;
        }

        .cal-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .dot.task {
            background: var(--primary);
        }

        .dot.plant {
            background: var(--success);
        }

        /* CocinAI Elements */
        .stock-badge {
            background: var(--bg-main);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
        }

        .stock-badge button {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.6rem;
            cursor: pointer;
        }

        /* Console */
        #debug-console {
            position: fixed;
            bottom: 85px;
            left: 5px;
            right: 5px;
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 10px;
            font-size: 0.6rem;
            border-radius: 8px;
            z-index: 9999;
            display: none;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 2000;
        }

        .modal-body {
            background: var(--bg-card);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            overflow-y: auto;
        }

        .smart-tip {
            background: linear-gradient(135deg, var(--primary-light), #fff);
            padding: 15px;
            border-radius: 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            border: 1px solid var(--primary-light);
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="light-mode">
    <!-- Login Screen -->
    <div id="login-screen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); gap:20px; padding:20px;">
        <h1 style="color:white; font-size:2.5rem;">üè† HomeHub</h1>
        <p style="color:rgba(255,255,255,0.95); font-size:1.1rem;">Organizaci√≥n del hogar para parejas</p>
        <input id="login-input" type="text" placeholder="Nombre de pareja (ej: Juan&Maria)" style="width:100%; max-width:320px; padding:15px; border:none; border-radius:12px; font-size:1rem; font-family:'Outfit', sans-serif;">
        <button id="login-btn" style="width:100%; max-width:320px; padding:15px; background:white; color:var(--primary); border:none; border-radius:12px; cursor:pointer; font-weight:700; font-size:1rem; font-family:'Outfit', sans-serif;">Entrar</button>
        <p style="font-size:0.75rem; color:rgba(255,255,255,0.9); text-align:center; max-width:300px;">Ambos usan el MISMO nombre para compartir datos en tiempo real</p>
    </div>

    <div id="app" style="display:none;">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="display: flex;">
                    <div class="avatar"
                        style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix')"></div>
                    <div class="avatar"
                        style="background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka')"></div>
                </div>
                <div class="header-text">
                    <h1>Nuestro Hogar</h1>
                    <p id="current-date">Hoy</p>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button onclick="logout()" class="icon-btn" title="Salir"><i class="fa-solid fa-sign-out-alt"></i></button>
                <button onclick="window.resetApp()" class="icon-btn" title="Reset"><i
                        class="fa-solid fa-rotate-right"></i></button>
                <button id="theme-toggle" class="icon-btn"><i class="fa-solid fa-moon"></i></button>
            </div>
        </header>

        <main id="main-content">
            <div id="view-container"></div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard"><i
                    class="fa-solid fa-house"></i><span>Inicio</span></button>
            <button class="nav-item" data-view="shopping"><i
                    class="fa-solid fa-cart-shopping"></i><span>Compras</span></button>
            <button class="nav-item" data-view="tasks"><i
                    class="fa-solid fa-list-check"></i><span>Tareas</span></button>
            <button class="nav-item" data-view="calendar"><i
                    class="fa-solid fa-calendar-days"></i><span>Agenda</span></button>
            <button class="nav-item" data-view="meals"><i class="fa-solid fa-utensils"></i><span>CocinAI</span></button>
            <button class="nav-item" data-view="more"><i class="fa-solid fa-ellipsis"></i><span>M√°s</span></button>
        </nav>
    </div>

    <!-- Debug Log -->
    <div id="debug-console"></div>

    <!-- Modal Receta -->
    <div id="recipe-modal" class="modal" onclick="closeRecipeModal()">
        <div class="modal-body" onclick="event.stopPropagation()">
            <div id="recipe-modal-content"></div>
            <button
                style="width:100%; padding:15px; border:none; border-radius:12px; background:var(--primary); color:white; margin-top:25px; font-weight:900;"
                onclick="closeRecipeModal()">ACEPTAR</button>
        </div>
    </div>

    <script>
        // --- üõ°Ô∏è ERRORES ---
        window.onerror = function (msg, url, line) {
            var d = document.getElementById('debug-console');
            if (d) { d.style.display = 'block'; d.innerHTML = 'üî¥ ' + msg + '<br><small>' + line + '</small>'; }
            return false;
        };

        var SUPABASE_URL = 'https://blckzxhtpxxwhlsksrzz.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsY2t6eGh0cHh4d2hsc2tzcnp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjU2MTgsImV4cCI6MjA4NjM0MTYxOH0.z62ADKWvhCvHSN2mHEqk_PCDEV_Jnn5g2wGPcK-he3g';
        var currentUser = null;
        var client = null;
        var channel = null;
        var isCloudLoaded = false;
        var sessionId = Math.random().toString(36).substring(7);
        var isRealtimeActive = false;

        // --- üç≥ COCINAI DATA ---
        var RECIPE_BOOK = [
            { name: 'Pollo con Jam√≥n y Queso', ingredients: ['Pollo', 'Jam√≥n', 'Queso'], steps: ['Poner el pollo al medio.', 'Rellenar.', 'Cocinar.'], tip: 'Usar palillos.' },
            { name: 'Pasta con Jam√≥n y Crema', ingredients: ['Pasta', 'Jam√≥n'], steps: ['Hervir pasta.', 'Saltear jam√≥n.', 'Mezclar con crema.'], tip: 'Pimienta negra.' },
            { name: 'Tarta de Jam√≥n y Queso', ingredients: ['Masa', 'Jam√≥n', 'Queso'], steps: ['Poner masa.', 'Rellenar.', 'Hornear 20 min.'], tip: 'A√±adir or√©gano.' }
        ];

        // --- üì¶ STATE ---
        var state = {
            currentView: 'dashboard',
            activeShopFilter: 'Todos',
            data: {
                shopping: [{ id: 1, name: 'Leche', cat: 'almac√©n', bought: false }],
                tasks: [{ id: 1, title: 'Revisar HomeHub', status: 'pendiente', date: new Date().toISOString().split('T')[0], time: '12:00' }],
                plants: [{ id: 1, name: 'Monstera üåø', nextWater: new Date().toISOString().split('T')[0], freq: 7 }],
                expenses: { items: [] },
                meals: {
                    stock: ['Pollo', 'Jam√≥n'],
                    weekly: [
                        { day: 'Lunes', lunch: 'Pasta', dinner: 'Cena' },
                        { day: 'Martes', lunch: 'Pollo', dinner: 'Sopa' },
                        { day: 'Mi√©rcoles', lunch: 'Arroz', dinner: 'Tarta' },
                        { day: 'Jueves', lunch: 'Fideos', dinner: 'Pizza' },
                        { day: 'Viernes', lunch: 'Pescado', dinner: 'Burgers' },
                        { day: 'S√°bado', lunch: 'Asado', dinner: 'Empanadas' },
                        { day: 'Domingo', lunch: 'Pastas', dinner: 'Picada' }
                    ]
                }
            }
        };

        // --- üîê LOGIN/LOGOUT ---
        function login() {
            var name = document.getElementById('login-input').value.trim();
            if (!name) {
                alert('Escribe el nombre compartido de tu pareja');
                return;
            }
            currentUser = name;
            try { localStorage.setItem('homehub-user', name); } catch(e) { }
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            syncCloud();
            subscribeToChanges();
            renderView(state.currentView);
        }

        function logout() {
            if (channel) client.removeChannel(channel);
            currentUser = null;
            try { localStorage.removeItem('homehub-user'); } catch(e) { }
            
            document.getElementById('app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-input').value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('login-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        // --- üß± RENDER CORE (CON PROTECCIONES) ---
        function renderView(v) {
            state.currentView = v;
            var c = document.getElementById('view-container');
            if (!c) return;
            c.innerHTML = '';

            // Asegurar que la data base exista antes de renderizar
            if (!state.data) state.data = {};
            if (!state.data.shopping) state.data.shopping = [];
            if (!state.data.tasks) state.data.tasks = [];
            if (!state.data.plants) state.data.plants = [];
            if (!state.data.expenses) state.data.expenses = { items: [] };
            if (!state.data.meals) state.data.meals = { stock: [], weekly: [] };

            // Navegaci√≥n Activa
            var ns = document.querySelectorAll('.nav-item');
            for (var i = 0; i < ns.length; i++) {
                ns[i].classList.toggle('active', ns[i].getAttribute('data-view') === v);
            }

            try {
                if (v === 'dashboard') renderDashboard(c);
                else if (v === 'shopping') renderShopping(c);
                else if (v === 'tasks') renderTasks(c);
                else if (v === 'calendar') renderCalendar(c);
                else if (v === 'meals') renderMealPlanner(c);
                else if (v === 'plants') renderPlants(c);
                else if (v === 'expenses') renderExpenses(c);
                else if (v === 'more') renderMoreMenu(c);
            } catch (e) {
                window.onerror('Render Error (' + v + '): ' + e.message, '', 0);
            }
        }

        function renderDashboard(c) {
            var d = state.data;
            var sCount = (d.shopping || []).filter(function (i) { return !i.bought }).length;
            var tCount = (d.tasks || []).filter(function (t) { return t.status === 'pendiente' }).length;

            var now = new Date();
            var dayIdx = (now.getDay() + 6) % 7;
            var lunch = 'Plan pendiente';
            if (d.meals && d.meals.weekly && d.meals.weekly[dayIdx]) {
                lunch = d.meals.weekly[dayIdx].lunch || 'Plan pendiente';
            }

            c.innerHTML = '<div style="margin-bottom:20px;"><h2>¬°Hola! üëã</h2>' +
                '<p id="cloud-info" style="font-size:0.6rem; color:var(--text-muted); cursor:pointer;" onclick="syncCloud()">Sincronizando...</p></div>' +
                '<div class="smart-tip" onclick="renderView(\'meals\')"><i class="fa-solid fa-wand-magic-sparkles"></i><div><p style="font-size:0.8rem; font-weight:700;">CocinAI Sugiere</p><p style="font-size:0.7rem;">Optimiza tu stock. Toca para ver sugerencias.</p></div></div>' +
                '<div class="dash-grid">' +
                '<div class="dash-card" onclick="renderView(\'shopping\')"><div class="card-icon"><i class="fa-solid fa-cart-shopping"></i></div><div><h3>Compras</h3><p>' + sCount + ' √≠tems</p></div></div>' +
                '<div class="dash-card" onclick="renderView(\'tasks\')"><div class="card-icon" style="background:hsl(145,50%,90%); color:var(--success)"><i class="fa-solid fa-list-check"></i></div><div><h3>Tareas</h3><p>' + tCount + ' para hoy</p></div></div>' +
                '<div class="dash-card full-width" onclick="renderView(\'meals\')" style="background:linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white;">' +
                '<div><p style="font-size:0.7rem; opacity:0.8;">Men√∫ de Hoy</p><h3 style="color:white">' + lunch + '</h3></div></div>' +
                '</div>' +
                '<button onclick="syncCloud()" style="width:100%; border:none; background:none; color:var(--primary); font-size:0.65rem; margin-top:20px; text-decoration:underline;">üîÑ Forzar Sincronizaci√≥n</button>';
            updateCloudUI();
        }

        function renderShopping(c) {
            var cats = ['Todos', 'almac√©n', 'verduler√≠a', 'limpieza', 'otros'];
            var items = (state.data.shopping || []).filter(function (i) {
                return state.activeShopFilter === 'Todos' || i.cat === state.activeShopFilter;
            });

            c.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h2>üõí Compras</h2><button class="icon-btn" onclick="addShop()"><i class="fa-solid fa-plus"></i></button></div>' +
                '<div class="chips-scroll">' + cats.map(function (cat) {
                    return '<button class="chip ' + (state.activeShopFilter === cat ? 'active' : '') + '" onclick="setShopFilter(\'' + cat + '\')">' + cat + '</button>';
                }).join('') + '</div>' +
                '<div>' + (items.length ? items.map(function (i) {
                    return '<div class="list-item"><div style="display:flex; align-items:center; gap:12px;" onclick="toggleShop(' + i.id + ')">' +
                        '<div class="custom-checkbox ' + (i.bought ? 'checked' : '') + '">' + (i.bought ? '‚úì' : '') + '</div>' +
                        '<div><span>' + (i.name || 'Sin nombre') + '</span><br><span class="label-cat">' + (i.cat || 'otros') + '</span></div></div>' +
                        '<button class="icon-btn" style="width:28px;height:28px;color:var(--danger)" onclick="delShop(' + i.id + ')"><i class="fa-solid fa-trash"></i></button></div>';
                }).join('') : '<p style="text-align:center; opacity:0.5; font-size:0.8rem; margin-top:20px;">No hay √≠tems en esta categor√≠a.</p>') + '</div>';
        }

        function renderTasks(c) {
            var tasks = state.data.tasks || [];
            c.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>üßπ Tareas</h2><button class="icon-btn" onclick="addTask()"><i class="fa-solid fa-plus"></i></button></div>' +
                (tasks.length ? tasks.map(function (t) {
                    return '<div class="dash-card" style="border-left:5px solid ' + (t.status === 'finalizado' ? 'var(--success)' : 'var(--primary)') + '">' +
                        '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                        '<div><h4 style="' + (t.status === 'finalizado' ? 'text-decoration:line-through' : '') + '">' + (t.title || 'Tarea') + '</h4><p style="font-size:0.65rem; color:var(--text-muted)">' + (t.date || '-') + ' ‚Ä¢ ' + (t.time || '-') + '</p></div>' +
                        '<div style="display:flex; gap:8px;"><button class="icon-btn" onclick="toggleTask(' + t.id + ')"><i class="fa-solid fa-check"></i></button>' +
                        '<button class="icon-btn" style="color:var(--danger)" onclick="delTask(' + t.id + ')"><i class="fa-solid fa-trash"></i></button></div></div></div>';
                }).join('') : '<p style="text-align:center; opacity:0.5; font-size:0.8rem;">No hay tareas pendientes.</p>');
        }

        function renderMealPlanner(c) {
            if (!state.data.meals) state.data.meals = { stock: [], weekly: [] };
            var stock = state.data.meals.stock || [];
            var weekly = state.data.meals.weekly || [];

            c.innerHTML = '<h2>üçΩÔ∏è CocinAI Pro</h2>' +
                '<div style="background:var(--bg-card); padding:15px; border-radius:15px; margin:15px 0; border:1px solid var(--border);">' +
                '<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h4>üì¶ Mi Stock</h4><button class="icon-btn" onclick="addStock()">+</button></div>' +
                '<div style="display:flex; gap:8px; flex-wrap:wrap;">' + (stock.map(function (s) { return '<div class="stock-badge">' + s + '<button onclick="delStock(\'' + s + '\')">x</button></div>' }).join('') || '<p style="font-size:0.7rem; opacity:0.5;">Sin ingredientes.</p>') + '</div></div>' +
                (weekly.length ? weekly.map(function (day, i) {
                    return '<div class="dash-card"><div style="display:flex; justify-content:space-between;"><h4 style="color:var(--primary)">' + (day.day || '-') + '</h4><button class="icon-btn" onclick="editMeal(' + i + ')"><i class="fa-solid fa-pen"></i></button></div>' +
                        '<div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">' +
                        '<div onclick="viewRec(\'' + (day.lunch || '') + '\')"><p style="font-size:0.55rem; color:var(--text-muted)">ALMUERZO</p><b>' + (day.lunch || 'Pendiente') + '</b></div>' +
                        '<button class="icon-btn" style="color:var(--primary)" onclick="genMeal(' + i + ')"><i class="fa-solid fa-wand-sparkles"></i></button></div></div>';
                }).join('') : '<button onclick="resetApp()" style="width:100%; padding:10px;">Restaurar Calendario (Falta Data)</button>');
        }

        function renderPlants(c) {
            var plants = state.data.plants || [];
            c.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>üå± Mis Plantas</h2><button class="icon-btn" onclick="addPlant()"><i class="fa-solid fa-plus"></i></button></div>' +
                '<div class="dash-grid">' + (plants.length ? plants.map(function (p) {
                    return '<div class="dash-card" style="text-align:center;"><div style="font-size:2rem">üåø</div><h4>' + (p.name || 'Planta') + '</h4><p style="font-size:0.6rem; color:var(--text-muted)">Prox Riego: ' + (p.nextWater || '-') + '</p>' +
                        '<button class="icon-btn" style="width:100%; background:var(--primary); color:white; margin-top:5px;" onclick="water(' + p.id + ')">Regar</button></div>';
                }).join('') : '<p class="full-width" style="text-align:center; opacity:0.5; font-size:0.8rem;">No hay plantas registradas.</p>') + '</div>';
        }

        function renderExpenses(c) {
            if (!state.data.expenses) state.data.expenses = { items: [] };
            var items = state.data.expenses.items || [];
            var total = items.reduce(function (a, b) { return a + (b.amount || 0) }, 0);
            c.innerHTML = '<h2>üí∞ Gastos</h2><div class="dash-card" style="background:var(--primary); color:white; padding:20px; text-align:center;"><p style="opacity:0.8;">Total Mes</p><h3>$' + total.toLocaleString() + '</h3></div>' +
                '<button class="icon-btn" style="width:100%; height:45px; margin-bottom:15px;" onclick="addExp()">+ Registrar</button>' +
                (items.length ? items.map(function (i) {
                    return '<div class="list-item"><div><h4>' + (i.desc || 'Gasto') + '</h4><p style="font-size:0.6rem; color:var(--text-muted)">' + (i.cat || 'otros') + ' ‚Ä¢ ' + (i.date || '-') + '</p></div><b>$' + (i.amount || 0) + '</b></div>';
                }).join('') : '<p style="text-align:center; opacity:0.5; font-size:0.8rem;">Sin gastos registrados.</p>');
        }

        function renderCalendar(c) {
            var now = new Date(); var m = now.getMonth(); var y = now.getFullYear();
            var months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            var ds = new Date(y, m + 1, 0).getDate();
            var start = (new Date(y, m, 1).getDay() + 6) % 7;
            c.innerHTML = '<h2>üìÖ Agenda - ' + months[m] + '</h2><div class="calendar-grid" style="margin-top:10px;">' +
                ['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(function (d) { return '<div style="background:var(--bg-main); font-size:0.6rem; font-weight:800; padding:5px; text-align:center;">' + d + '</div>' }).join('') +
                Array(start).fill(0).map(function () { return '<div class="cal-day" style="opacity:0.1"></div>' }).join('') +
                Array(ds).fill(0).map(function (_, i) {
                    var d = i + 1;
                    var dateStr = y + '-' + (m + 1).toString().padStart(2, '0') + '-' + d.toString().padStart(2, '0');
                    var hasT = (state.data.tasks || []).some(function (t) { return t.date === dateStr });
                    return '<div class="cal-day ' + (d === now.getDate() ? 'today' : '') + '"><span>' + d + '</span><div class="cal-dots">' + (hasT ? '<div class="dot task"></div>' : '') + '</div></div>';
                }).join('') + '</div>';
        }

        function renderMoreMenu(c) {
            c.innerHTML = '<h2>‚ú® M√°s M√≥dulos</h2><br>' +
                '<div class="dash-card row" onclick="renderView(\'plants\')" style="flex-direction:row; align-items:center; border:1px solid var(--primary-light); background:var(--primary-light);">' +
                '<div class="card-icon"><i class="fa-solid fa-leaf"></i></div><div style="margin-left:15px"><b>üå± Mis Plantas</b><p style="font-size:0.7rem">Control de riego y cuidado.</p></div></div>' +
                '<div class="dash-card row" onclick="renderView(\'expenses\')" style="flex-direction:row; align-items:center;">' +
                '<div class="card-icon" style="background:hsl(145,50%,90%); color:var(--success)"><i class="fa-solid fa-wallet"></i></div><div style="margin-left:15px"><b>üí∞ Gastos Compartidos</b><p style="font-size:0.7rem">Saldos y cuentas del mes.</p></div></div>';
        }

        // --- ‚ö° ACCIONES (FORMULARIOS COMPLETOS) ---
        function addShop() {
            var n = prompt('¬øQu√© falta?');
            if (n) {
                var c = prompt('Categor√≠a (almacen, verduleria, limpieza, otros):', 'almac√©n');
                if (!state.data.shopping) state.data.shopping = [];
                state.data.shopping.unshift({ id: Date.now(), name: n, cat: (c || 'otros').toLowerCase(), bought: false });
                renderView('shopping');
                saveState();
            }
        }
        function toggleShop(id) { var i = (state.data.shopping || []).find(function (x) { return x.id === id }); if (i) { i.bought = !i.bought; renderView('shopping'); saveState(); } }
        function delShop(id) { if (confirm('¬øBorrar?')) { state.data.shopping = (state.data.shopping || []).filter(function (x) { return x.id !== id }); renderView('shopping'); saveState(); } }
        function setShopFilter(cat) { state.activeShopFilter = cat; renderView('shopping'); }

        function addTask() {
            var t = prompt('Responsabilidad:');
            if (t) {
                var d = prompt('Fecha (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
                var h = prompt('Hora (HH:MM):', '12:00');
                if (!state.data.tasks) state.data.tasks = [];
                state.data.tasks.unshift({ id: Date.now(), title: t, status: 'pendiente', date: (d || '-'), time: (h || '-') });
                renderView('tasks');
                saveState();
            }
        }
        function toggleTask(id) { var t = (state.data.tasks || []).find(function (x) { return x.id === id }); if (t) { t.status = t.status === 'pendiente' ? 'finalizado' : 'pendiente'; renderView('tasks'); saveState(); } }
        function delTask(id) { if (confirm('¬øEliminar?')) { state.data.tasks = (state.data.tasks || []).filter(function (x) { return x.id !== id }); renderView('tasks'); saveState(); } }

        function addExp() {
            var d = prompt('Gasto:');
            var a = parseFloat(prompt('Monto:'));
            if (d && !isNaN(a)) {
                var c = prompt('Categor√≠a (super, servicios, ocio):', 'super');
                if (!state.data.expenses) state.data.expenses = { items: [] };
                if (!state.data.expenses.items) state.data.expenses.items = [];
                state.data.expenses.items.unshift({ id: Date.now(), desc: d, amount: a, cat: (c || 'otros'), date: new Date().toISOString().split('T')[0] });
                renderView('expenses');
                saveState();
            }
        }

        function addStock() { var i = prompt('Ingrediente:'); if (i) { if (!state.data.meals) state.data.meals = { stock: [], weekly: [] }; if (!state.data.meals.stock) state.data.meals.stock = []; state.data.meals.stock.push(i); renderView('meals'); saveState(); } }
        function delStock(s) { state.data.meals.stock = (state.data.meals.stock || []).filter(function (x) { return x !== s }); renderView('meals'); saveState(); }
        function genMeal(i) {
            var s = (state.data.meals || {}).stock || [];
            var ms = RECIPE_BOOK.filter(function (r) { return r.ingredients.some(function (ing) { return s.indexOf(ing) !== -1 }) });
            if (ms.length > 0) {
                var r = ms[Math.floor(Math.random() * ms.length)];
                state.data.meals.weekly[i].lunch = r.name;
                alert('‚ú® CocinAI Sigiere: ' + r.name);
                renderView('meals');
                saveState();
            } else { alert('Agrega m√°s ingredientes al stock.'); }
        }
        function viewRec(name) {
            var r = RECIPE_BOOK.find(function (x) { return x.name === name });
            var m = document.getElementById('recipe-modal');
            var c = document.getElementById('recipe-modal-content');
            if (r) {
                c.innerHTML = '<h2>' + r.name + '</h2><hr><br><h4>Ingredientes:</h4><p>' + r.ingredients.join(', ') + '</p><br>' +
                    '<h4>Pamos:</h4>' + r.steps.map(function (s, k) { return '<p>' + (k + 1) + '. ' + s + '</p>' }).join('') + '<br><br><i>üí° Tip: ' + r.tip + '</i>';
            } else { c.innerHTML = '<h3>' + (name || 'Comida') + '</h3><p>Receta pendiente.</p>'; }
            m.style.display = 'flex';
        }
        function closeRecipeModal() { var m = document.getElementById('recipe-modal'); if (m) m.style.display = 'none'; }

        function addPlant() {
            var n = prompt('Nombre de la planta:');
            if (n) {
                var f = parseInt(prompt('Riego cada (d√≠as):', '7'));
                if (!state.data.plants) state.data.plants = [];
                state.data.plants.push({ id: Date.now(), name: n + ' üåø', nextWater: new Date().toISOString().split('T')[0], freq: (f || 7) });
                renderView('plants');
                saveState();
            }
        }
        function water(id) { var p = (state.data.plants || []).find(function (x) { return x.id === id }); if (p) { var d = new Date(); d.setDate(d.getDate() + (p.freq || 7)); p.nextWater = d.toISOString().split('T')[0]; renderView('plants'); saveState(); } }
        function editMeal(i) { var n = prompt('Plato:', (state.data.meals.weekly[i] || {}).lunch || ''); if (n) { if (!state.data.meals.weekly[i]) state.data.meals.weekly[i] = { day: 'D√≠a ' + i }; state.data.meals.weekly[i].lunch = n; renderView('meals'); saveState(); } }

        // --- üõ°Ô∏è BLINDAJE DE DATOS (ANTI-CRASH) ---
        function applyData(newData) {
            if (!newData || typeof newData !== 'object') return;

            // Estructura base por defecto
            var def = {
                shopping: [],
                tasks: [],
                plants: [],
                expenses: { items: [] },
                meals: {
                    stock: [],
                    weekly: [
                        { day: 'Lunes', lunch: 'Pasta', dinner: 'Cena' },
                        { day: 'Martes', lunch: 'Pollo', dinner: 'Sopa' },
                        { day: 'Mi√©rcoles', lunch: 'Arroz', dinner: 'Tarta' },
                        { day: 'Jueves', lunch: 'Fideos', dinner: 'Pizza' },
                        { day: 'Viernes', lunch: 'Pescado', dinner: 'Burgers' },
                        { day: 'S√°bado', lunch: 'Asado', dinner: 'Empanadas' },
                        { day: 'Domingo', lunch: 'Pastas', dinner: 'Picada' }
                    ]
                }
            };

            // Sanitizaci√≥n Profunda (con protecci√≥n ante nulos previos)
            var old = state.data || def;
            if (!newData.shopping || !Array.isArray(newData.shopping)) newData.shopping = old.shopping || def.shopping;
            if (!newData.tasks || !Array.isArray(newData.tasks)) newData.tasks = old.tasks || def.tasks;
            if (!newData.plants || !Array.isArray(newData.plants)) newData.plants = old.plants || def.plants;

            if (!newData.expenses || typeof newData.expenses !== 'object') newData.expenses = old.expenses || def.expenses;
            if (!newData.expenses.items || !Array.isArray(newData.expenses.items)) newData.expenses.items = (old.expenses || {}).items || def.expenses.items;

            if (!newData.meals || typeof newData.meals !== 'object') newData.meals = old.meals || def.meals;
            if (!newData.meals.stock || !Array.isArray(newData.meals.stock)) newData.meals.stock = (old.meals || {}).stock || def.meals.stock;
            if (!newData.meals.weekly || !Array.isArray(newData.meals.weekly) || newData.meals.weekly.length === 0) {
                newData.meals.weekly = (old.meals || {}).weekly || def.meals.weekly;
            }

            state.data = newData;
        }

        // --- ‚òÅÔ∏è NUBE ---
        function saveState() {
            if (!currentUser) return;
            try {
                localStorage.setItem('homehub_v3_' + currentUser, JSON.stringify(state.data));
                if (client && isCloudLoaded) {
                    client.from('homehub_data').upsert({ user_name: currentUser, data_json: JSON.stringify(state.data), updated_at: new Date().toISOString() }, { onConflict: 'user_name' })
                        .then(function (res) { updateCloudUI(res); })
                        .catch(function (err) { updateCloudUI({ error: err }); });

                    if (channel && isRealtimeActive) {
                        channel.send({
                            type: 'broadcast',
                            event: 'sync',
                            payload: { data: state.data, sid: sessionId, user: currentUser }
                        });
                    }
                }
            } catch (e) { }
        }
        function loadState() {
            var s = localStorage.getItem('homehub_v3') || localStorage.getItem('homehub_state');
            if (s) { try { applyData(JSON.parse(s)); } catch (e) { } }
        }
        function syncCloud() {
            if (!client || !currentUser) return;
            client.from('homehub_data').select('data_json').eq('user_name', currentUser).single().then(function (res) {
                isCloudLoaded = true;
                if (res.data && res.data.data_json) {
                    applyData(JSON.parse(res.data.data_json));
                    renderView(state.currentView);
                    updateCloudUI({ error: null });
                }
            }).catch(function (err) {
                isCloudLoaded = true;
                updateCloudUI({ error: err });
            });
        }
        function updateCloudUI(res) {
            var el = document.getElementById('cloud-info');
            if (el) {
                if (res && res.error) { el.textContent = '‚ö†Ô∏è Solo Modo Local'; el.style.color = 'var(--danger)'; }
                else if (res && res.realtime) { el.textContent = '‚ö° Conectado En Vivo'; el.style.color = 'var(--success)'; }
                else { el.textContent = '‚òÅÔ∏è Sincronizado'; el.style.color = 'var(--text-muted)'; }
            }
        }
        function subscribeToChanges() {
            if (!client || !currentUser) return;
            if (channel) client.removeChannel(channel);
            
            var channelName = 'homehub-' + currentUser.replace(/[^a-zA-Z0-9]/g, '-');
            channel = client.channel(channelName, {
                config: { broadcast: { self: false } }
            });

            channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'homehub_data', filter: 'user_name=eq.' + currentUser }, function (p) {
                    if (p.new && p.new.data_json) {
                        applyData(JSON.parse(p.new.data_json));
                        renderView(state.currentView);
                        updateCloudUI({ realtime: true });
                    }
                })
                .on('broadcast', { event: 'sync' }, function (p) {
                    if (p.payload && p.payload.sid !== sessionId && p.payload.user === currentUser) {
                        applyData(p.payload.data);
                        renderView(state.currentView);
                        updateCloudUI({ realtime: true });
                    }
                })
                .subscribe(function (status) {
                    isRealtimeActive = (status === 'SUBSCRIBED');
                    updateCloudUI({ realtime: isRealtimeActive });
                });
        }

        // --- üõ†Ô∏è SETUP ---
        function updateDate() {
            var el = document.getElementById('current-date');
            if (el) el.textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        function setupNavigation() {
            var ns = document.querySelectorAll('.nav-item');
            for (var i = 0; i < ns.length; i++) {
                ns[i].onclick = function () {
                    renderView(this.getAttribute('data-view'));
                };
            }
        }
        function setupThemeToggle() {
            var btn = document.getElementById('theme-toggle');
            if (btn) btn.onclick = function () { document.body.classList.toggle('dark-mode'); };
        }
        function setupQuickActions() {
            var btn = document.getElementById('quick-action-btn');
            if (btn) btn.onclick = function () { var a = prompt('1: Gasto, 2: Tarea, 3: Compra'); if (a === '1') addExp(); else if (a === '2') addTask(); else if (a === '3') addShop(); };
        }
        window.resetApp = function () {
            if (confirm('¬øBorrar TODO los datos locales y recargar?')) {
                localStorage.clear();
                location.reload();
            }
        };

        // --- üöÄ INICIO RESILIENTE ---
        function initApp() {
            try {
                if (window.supabase) {
                    client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else {
                    setTimeout(function () {
                        if (window.supabase && !client) {
                            client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                        }
                    }, 3000);
                }
                
                // Auto-login si hay usuario guardado
                var savedUser = null;
                try { savedUser = localStorage.getItem('homehub-user'); } catch(e) { }
                
                if (savedUser) {
                    currentUser = savedUser;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    
                    syncCloud();
                    subscribeToChanges();
                }
                
                loadState();
                updateDate();
                setupNavigation();
                setupThemeToggle();
                setupQuickActions();
                renderView('dashboard');
                
                setInterval(function () {
                    if (!isRealtimeActive && client && currentUser) subscribeToChanges();
                }, 30000);
            } catch (e) {
                window.onerror('Init: ' + e.message, '', 0);
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>

</html>
